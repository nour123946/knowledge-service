<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>AI Assistant</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    padding: 20px;
}

#chat-box {
    width: 420px;
    height: 650px;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

#chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    font-weight: 600;
    font-size: 18px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: linear-gradient(to bottom, #f8f9fd 0%, #ffffff 100%);
}

#messages::-webkit-scrollbar {
    width: 6px;
}

#messages::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 10px;
}

.msg {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    margin: 10px 0;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.bot {
    background: #f3f4f6;
    color: #1f2937;
    margin-right: auto;
    border-bottom-left-radius: 4px;
    border: 1px solid #e5e7eb;
}

.escalation {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
    color: #92400e;
    padding: 16px;
    margin: 12px 0;
    border-radius: 12px;
    text-align: center;
    max-width: 100% !important;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
}

.loader {
    font-style: italic;
    opacity: 0.7;
    color: #6b7280;
}

/* ‚úÖ FEEDBACK BUTTONS */
.feedback-container {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid #e5e7eb;
}

.feedback-btn {
    padding: 8px 16px;
    border: 2px solid #e5e7eb;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.feedback-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.feedback-btn.positive:hover {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border-color: #10b981;
    color: #065f46;
}

.feedback-btn.negative:hover {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border-color: #ef4444;
    color: #991b1b;
}

.feedback-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.feedback-thanks {
    font-size: 12px;
    color: #10b981;
    font-weight: 700;
    margin-top: 10px;
    padding: 8px;
    background: #d1fae5;
    border-radius: 8px;
    text-align: center;
}

#input-box {
    display: flex;
    border-top: 1px solid #e5e7eb;
    background: white;
    padding: 12px;
    gap: 10px;
}

input {
    flex: 1;
    padding: 14px 18px;
    border: 2px solid #e5e7eb;
    border-radius: 24px;
    outline: none;
    font-size: 14px;
    transition: border 0.2s;
}

input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
    padding: 0 24px;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    cursor: pointer;
    border-radius: 24px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

button:active {
    transform: translateY(0);
}
</style>
</head>

<body>

<div id="chat-box">
<div id="chat-header">ü§ñ AI Assistant</div>
<div id="messages"></div>

<div id="input-box">
<input id="userInput" placeholder="Posez votre question..." />
<button onclick="sendMessage()">‚û§</button>
</div>
</div>

<script>
const messages=document.getElementById("messages");
const input=document.getElementById("userInput");

// ‚úÖ G√©n√©ration d'un session_id unique par utilisateur
const sessionId = 'web_user_' + Math.random().toString(36).substr(2, 9);

// üÜï VARIABLE POUR STOCKER L'√âTAT DE LA CONVERSATION
let conversationState = null;

// ‚úÖ Stocker les donn√©es du dernier message pour le feedback
let lastBotMessage = null;

console.log("üÜî Session ID:", sessionId);

input.addEventListener("keypress",e=>{
if(e.key==="Enter") sendMessage();
});

function addMessage(text,cls){
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${cls}`;
    msgDiv.innerHTML = text;
    messages.appendChild(msgDiv);
    messages.scrollTop = messages.scrollHeight;
}

// ‚úÖ NOUVELLE FONCTION : Ajouter message avec boutons de feedback
function addMessageWithFeedback(text, cls, messageId, userMessage, botResponse, intent, confidence){
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${cls}`;
    msgDiv.innerHTML = `
        ${text}
        <div class="feedback-container" id="feedback-${messageId}">
            <button class="feedback-btn positive" onclick="submitFeedback('${messageId}', 'positive', \`${escapeHtml(userMessage)}\`, \`${escapeHtml(botResponse)}\`, '${intent}', ${confidence})">
                üëç Utile
            </button>
            <button class="feedback-btn negative" onclick="submitFeedback('${messageId}', 'negative', \`${escapeHtml(userMessage)}\`, \`${escapeHtml(botResponse)}\`, '${intent}', ${confidence})">
                üëé Pas utile
            </button>
        </div>
    `;
    messages.appendChild(msgDiv);
    messages.scrollTop = messages.scrollHeight;
}

// ‚úÖ √âchapper les caract√®res HTML pour √©viter les probl√®mes
function escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/\\/g, "\\\\")
        .replace(/`/g, "\\`")
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, "\\n");
}

// ‚úÖ FONCTION : Soumettre le feedback
async function submitFeedback(messageId, rating, userMessage, botResponse, intent, confidence) {
    const container = document.getElementById(`feedback-${messageId}`);
    const buttons = container.querySelectorAll('.feedback-btn');
    
    // D√©sactiver les boutons
    buttons.forEach(btn => btn.disabled = true);

    try {
        const response = await fetch('http://127.0.0.1:8000/feedback', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message_id: messageId,
                session_id: sessionId,
                user_message: userMessage,
                bot_response: botResponse,
                rating: rating,
                intent: intent,
                confidence: confidence
            })
        });

        if (response.ok) {
            // Afficher message de remerciement
            container.innerHTML = `
                <div class="feedback-thanks">
                    ‚úÖ Merci pour votre retour !
                </div>
            `;
        } else {
            console.error('Feedback submission failed');
            buttons.forEach(btn => btn.disabled = false);
        }

    } catch (error) {
        console.error('Error submitting feedback:', error);
        buttons.forEach(btn => btn.disabled = false);
    }
}

async function sendMessage(){

const text=input.value.trim();
if(!text) return;

addMessage(text,"user");
input.value="";

const loaderId="loader_" + Date.now();
const loaderDiv = document.createElement('div');
loaderDiv.id = loaderId;
loaderDiv.className = 'msg bot loader';
loaderDiv.textContent = 'ü§î AI is thinking...';
messages.appendChild(loaderDiv);
messages.scrollTop = messages.scrollHeight;

try{

// üÜï ENVOYER L'√âTAT DE LA CONVERSATION
const res=await fetch("http://127.0.0.1:8000/ask",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
query: text,
session_id: sessionId,
channel: "web",
low_conf_history: 0,
conversation_state: conversationState  // üÜï AJOUT√â ICI
})
});

document.getElementById(loaderId)?.remove();

if(!res.ok){
addMessage("‚ùå Erreur serveur (Code: " + res.status + ")","bot");
return;
}

const data=await res.json();

console.log("üìä API RESPONSE:",data);

// üÜï SAUVEGARDER LE NOUVEL √âTAT
conversationState = data.conversation_state;
console.log("üîÑ Conversation State:", conversationState);

// ‚úÖ R√©cup√©rer la r√©ponse finale
const answer = data.final_answer || data.answer || "Pas de r√©ponse";
const messageId = data.message_id || 'msg_' + Date.now();
const intent = data.intent || 'unknown';
const confidence = data.confidence || 0;

// üî• V√âRIFICATION DE L'ESCALATION (CORRIG√âE)
const needsEscalation = data.needs_human_agent === true || data.should_escalate === true;

console.log("üö® Escalation check:", {
    needs_human_agent: data.needs_human_agent,
    should_escalate: data.should_escalate,
    needsEscalation: needsEscalation,
    escalation_reason: data.escalation_reason
});

// ‚úÖ Toujours afficher la r√©ponse du bot
addMessageWithFeedback(
    answer,
    "bot",
    messageId,
    text,
    answer,
    intent,
    confidence
);

// üî• SI ESCALATION : Afficher le bandeau
if (needsEscalation) {
    console.log("‚ö†Ô∏è DISPLAYING ESCALATION BANNER");
    
    addMessage(
        `<strong>‚ö†Ô∏è Connexion √† un agent humain demand√©e</strong><br><br>
        <strong>Raison :</strong> ${data.escalation_reason || "Demande non r√©solue"}<br><br>
        Un agent vous contactera bient√¥t. üôã‚Äç‚ôÇÔ∏è`,
        "escalation"
    );
}

}catch(err){
document.getElementById(loaderId)?.remove();
addMessage("‚ùå Erreur connexion serveur","bot");
console.error("Error:",err);
}
}

// ‚úÖ Message de bienvenue
window.addEventListener('load', () => {
addMessage("üëã Bonjour ! Je suis votre assistant IA. Comment puis-je vous aider ?","bot");
});
</script>

</body>
</html>